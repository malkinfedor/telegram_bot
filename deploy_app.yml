# Ansible playbook for deploying a Flask app
#
---

# Install all requirments and deploy app
 - hosts: bots
   become: yes
   become_method: sudo
   tasks:

   - name: Create asusin user and his home folder
     user:
      name: asusin
      state: present
      createhome: yes
      home: /home/asusin

   - name: Check if EPEL repo is already configured.
     stat: path=/etc/yum.repos.d/epel.repo
     register: epel_repofile_result

   - name: Install EPEL repo.
     yum:
      name: "https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm"
      state: present
     register: result
     until: 'result.rc == 0'
     retries: 5
     delay: 10
     when: not epel_repofile_result.stat.exists

   - name: Import EPEL GPG key.
     rpm_key:
      key: "/etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7"
      state: present
     when: not epel_repofile_result.stat.exists

   - name: Install python
     yum: name=python34 state=present update_cache=yes

   - name: Install easyinstall
     yum: name=python34-setuptools state=present update_cache=yes
 
   - name: Install virtualenv
     yum: name=python-virtualenv state=present update_cache=yes

   - name: install pip with easy_install
     easy_install: 
      name: pip
      executable: easy_install-3.4
      state: latest

#   - name: install modules in a virtualenv #Try Install with yum (python-virtualenv)
#     pip:
#       name: virtualenv
#       state: present
#     become: yes
#
   - name: install git
     yum: name=git state=present update_cache=yes

   - name: clone repo
     become: no
     git:
       repo: 'https://github.com/malkinfedor/telegram_bot.git'
       dest: /home/asusin/telegram-bot
       update: yes

   - name: create venv 
     become: no
     pip:
       requirements: /home/asusin/telegram-bot/requirements.txt
       virtualenv: /home/asusin/telegram-bot/env
       virtualenv_python: python3.4


# Create service, start and enable

 - hosts: bots
   become: yes
   become_method: sudo
   tasks:
   - name: copy template systemd service config
     copy:
      src: telegram-bot.service 
      dest: /etc/systemd/system/telegram-bot.service

   - name: start systemd app service
     systemd: name=telegram-bot.service state=restarted enabled=yes



