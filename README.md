# telegram_bot

Приложение написано на ЯП python с использованием принципов ООП.
Данная программа состоит из одного класса Monitoring(), который реализует в себе все необходимые методы и свойства для работы бота. Для взаимодействия с telegram используется библиотека python-telegram-bot (https://github.com/python-telegram-bot/python-telegram-bot).
Основные параметры берутся из конф файла. Нужно заметить, что при изменении параметров в файле, перезапуск приложения не требуется.
В данной реализации бот шлет сообщения в чат **asusin-channel**.

Класc имеет следующие входные параметры (значения по умолчанию, в случае если они не задаются при создании объекта,
заданы в скобках):


- *frequencyOfSend (60)*
- *frequencyOfCheck (1)*
- *confFile ("config.conf")*


Класс содержит следующие свойства:
- *frequencyOfCheck* (int) - частота опроса ссылки
- *frequencyOfSend* (int) - частота отправки оповещений в телеграм
- *confFile* (str) - имя конф файла, откуда берутся основные параметры.
- *tokenKey* (str)- токен бота(берется из конф файла
- *chatId* (str) - ID чата, в который отправляется уведомление (берется из конф файла)
- *url* (str) - ссылка для опроса (берется из конф файла)
- *urlContext* (str) - контекст для опроса (берется из конф файла)
- *ethalonString* (str) - эталонная строка, котора должна быть в теле ответа в нормальном случае (берется из конф файла)

Класс следующие методы:
- набор сеттеров, для возможности задать значения через внешний интерфейс класса.
- *get_conf_data()* - метод для получения значений переменных из конфигурационного файла.
- *get_body()* - метод, который позволяет получить тело ответа по заданным параметрам.
- *compare_withEthalon()* - позволяет сравнить строку, полученную методом get_body с эталонной.
- *send_to_telegramm()* - позволяет отправить сообщение в телетрам-чат с определенными заданными параметрами.
- *main()* - основной метод, который вызывается в конструкторе и вызывает другие методы данного класса для реализации логики мониторинга.


**Для деплоя данного бота через ansible следует сделать следующее** (работает на centos 7, так как используется systemd):**
- *git clone -b ansible  --single-branch https://github.com/malkinfedor/telegram_bot.git* - выполнить команду на сервере, откуда планируется запускать ansible playbook
- *cd telegram_bot*
- прописать в файл *inventory.yml* хосты, на которые планируется устанавливать данный бот
- *ansible-playbook -i inventory.yml  deploy.yml* - запустить ansible's playbook который установит необходимые утилиты ОС, приложение, запустит приложение и добавит его в автозагрузку.


**Unit-тестирование.**  
Все тесты расположены в файле unit_tests.py. Тестируются следующие методы класса Monitoring():
- Monitoring.compare_string()
- Monitoring.get_body().  


Так как в методе Monitoring.main() находится цикл while True, то при вызове этого методе не будут запускаться тесты. Что бы это обойти, сделана проверка на заданный параметр isTestMode при запуске программы, и если он задан, то метод Monitoring.main() не вызывается а тесты будут запущены в стандартном режиме.



**Для запуска unit-тестов** следует использовать следующий формат: *python3 -m unittest  -v unit_tests test*.    
При использовании развертывания через ansible playbook **deploy**, который находится в соответствующей ветке данного репозитория, в папке проекта создается файл bot_tests.sh, при запуске которого будут запущены unit-тесты проекта.

**Тестирование ansible playbooks**  
Для тестирования ansible playbooks в ветке ansible находятся тесты, написанные на serverspec, запускаются с помощью kitchen test suite с использованием kitchen-docker драйвера.  
Для запуска необходим установленный ruby не ниже 2.3.0 и docker не ниже 1.13.0.  
Что начать выполнение тестов нужно выполнить следующие команды:
- *git clone -b ansible  --single-branch https://github.com/malkinfedor/telegram_bot.git*
- *cd telegram_bot*
- *kitchen test*  
После запуске создастся контейнер с centos-7, на нем будут выполнены роли ansible и после этого будут запущены проверки serverspec.

